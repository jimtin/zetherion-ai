# Claude Code Instructions — Zetherion AI

## Git Push Process

**Before every push, run `./scripts/pre-push-tests.sh` and confirm ALL steps pass. Only push after the script completes successfully.**

The push pipeline is:

**Phase A** (Docker builds in background while fast tests run in foreground):

1. **Ruff lint** — `ruff check src/ tests/`
2. **Unit tests + 90% coverage gate** — `pytest tests/ -m "not integration and not discord_e2e" -n 8` (parallel, fails if coverage <90%)
3. **In-process integration tests** — all `tests/integration/test_*_http.py` etc. with `--no-cov`

**Phase B** (all E2E tests run concurrently once Docker is ready):

1. **All E2E tests (concurrent)** — these 3 groups run in parallel:
   - `test_e2e.py` — Docker E2E tests (gemini + ollama backends)
   - `test_health_e2e.py` + `test_update_e2e.py` + `test_telemetry_e2e.py` — service E2E tests
   - `test_discord_e2e.py` — Discord E2E tests (real bot + channel)
2. **Push** — only after all steps pass, run `git push`

If any step fails, fix the code and re-run from step 1. Docker is torn down automatically on exit.

## Test Enforcement

- A direct git pre-push hook (`.git/hooks/pre-push`) runs `scripts/pre-push-tests.sh` automatically on every push.
- Run `./scripts/pre-push-tests.sh` before every push. Confirm it passes. Then push.
- Do not push without running the full pipeline first.
- Do not use `git push --no-verify` or any equivalent flag.
- If tests fail, fix the code — do not remove or weaken the tests.
- Docker Desktop must be running before pushing (the script checks for this).
- If the git hook is missing, reinstall it: `cp scripts/pre-push-tests.sh .git/hooks/pre-push && chmod +x .git/hooks/pre-push` (or create a wrapper that calls `exec ./scripts/pre-push-tests.sh`).

## Running Tests Manually

```bash
# Unit tests only
pytest tests/ -m "not integration and not discord_e2e" --tb=short -q

# In-process integration tests (no Docker needed)
pytest tests/integration/test_skills_http.py tests/integration/test_heartbeat_cycle.py tests/integration/test_profile_pipeline.py tests/integration/test_agent_skills_http.py tests/integration/test_skills_e2e.py tests/integration/test_user_isolation.py tests/integration/test_encryption_at_rest.py tests/integration/test_health_skill_http.py tests/integration/test_update_skill_http.py tests/integration/test_telemetry_http.py tests/integration/test_api_http.py -m integration --tb=short -q

# Full pre-push suite (requires Docker)
./scripts/pre-push-tests.sh
```

## Project Structure

- **Source code**: `src/zetherion_ai/`
- **Unit tests**: `tests/`
- **Integration tests**: `tests/integration/`
- **Docker test config**: `docker-compose.test.yml`
- **Pre-push script**: `scripts/pre-push-tests.sh`
