#!/bin/bash
# Pre-push hook for SecureClaw
# Runs full test suite before allowing push to remote
# Install: ln -sf ../../.git-hooks/pre-push .git/hooks/pre-push

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo -e "${BLUE}  SecureClaw Pre-Push Checks${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════${NC}"
echo ""

# Check if we're in a virtual environment
if [ -z "$VIRTUAL_ENV" ]; then
    if [ -d ".venv" ]; then
        echo -e "${YELLOW}⚠${NC} Activating virtual environment..."
        source .venv/bin/activate
    else
        echo -e "${RED}✗${NC} Virtual environment not found"
        echo "  Run: python3.12 -m venv .venv && source .venv/bin/activate && pip install -e ."
        exit 1
    fi
fi

# Step 1: Run linting
echo -e "${BLUE}1/3${NC} Running linters..."
if ruff check src/ tests/; then
    echo -e "${GREEN}✓${NC} Linting passed"
else
    echo -e "${RED}✗${NC} Linting failed"
    echo ""
    echo "Fix linting issues before pushing:"
    echo "  ruff check --fix src/ tests/"
    exit 1
fi
echo ""

# Step 2: Run type checking
echo -e "${BLUE}2/3${NC} Running type checks..."
if mypy src/secureclaw --config-file=pyproject.toml; then
    echo -e "${GREEN}✓${NC} Type checking passed"
else
    echo -e "${RED}✗${NC} Type checking failed"
    echo ""
    echo "Fix type errors before pushing"
    exit 1
fi
echo ""

# Step 3: Run test suite (excluding slow integration tests)
echo -e "${BLUE}3/3${NC} Running test suite (unit tests only)..."
if pytest tests/ -m "not integration" -v --tb=short --cov=src/secureclaw --cov-report=term-missing; then
    echo ""
    echo -e "${GREEN}✓${NC} All unit tests passed"
else
    echo ""
    echo -e "${RED}✗${NC} Tests failed"
    echo ""
    echo "Fix failing tests before pushing"
    exit 1
fi

# Optional: Ask about running integration tests
if [ -n "$RUN_INTEGRATION_TESTS" ]; then
    echo ""
    echo -e "${BLUE}Running integration tests (this may take 2-3 minutes)...${NC}"
    if ./scripts/run-integration-tests.sh; then
        echo -e "${GREEN}✓${NC} Integration tests passed"
    else
        echo -e "${RED}✗${NC} Integration tests failed"
        echo ""
        echo "Integration tests failed. Push anyway? (not recommended)"
        read -p "Continue? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

echo ""
echo -e "${GREEN}═══════════════════════════════════════════════${NC}"
echo -e "${GREEN}  All Pre-Push Checks Passed! ✓${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════${NC}"
echo ""

exit 0
